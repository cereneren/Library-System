<!-- book-detail.component.html -->
<div class="container py-3" *ngIf="book">
  <div class="card shadow-sm">
    <div class="row g-0">

      <!-- Cover -->
      <div class="col-md-4 d-flex align-items-stretch">
        <div class="w-100 p-3 d-flex flex-column align-items-center justify-content-center bg-light">
          <div class="ratio" style="--bs-aspect-ratio: 150%; max-width: 320px;">
            <img
              [src]="'/api/books/' + book.id + '/cover'"
              (error)="usePlaceholder($event)"
              [alt]="book.title + ' cover'"
              style="width:100%; height:100%; object-fit:cover; border-radius:.5rem;"
              loading="lazy">
          </div>
          <span class="badge mt-3"
                [ngClass]="book.available ? 'bg-success' : 'bg-danger'">
            {{ book.available ? 'Available' : 'Loaned out' }}
          </span>
        </div>
      </div>

      <!-- Info + Actions -->
      <div class="col-md-8">
        <div class="card-body">

          <!-- Title row with actions -->
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div>
              <h3 class="mb-1">{{ book.title }}</h3>
              <div class="text-muted">{{ book.author || '—' }}</div>
            </div>
            <div class="d-flex gap-2">
              <button
                *ngIf="!isMember && !editMode"
                class="btn btn-success btn-sm"
                (click)="toggleEdit()"
                [disabled]="saving || deleting"
              >
                <i class="bi bi-pencil"></i>
              </button>
              <button *ngIf="!isMember" class="btn btn-danger btn-sm" (click)="confirmDelete()" [disabled]="saving || deleting">
                <i class="bi bi-trash-fill"></i>
              </button>
            </div>
          </div>

          <!-- Meta -->
          <div class="mt-3 small">
            <div class="text-secondary">Created: {{ book.dateCreated | date:'medium' }}</div>
            <div class="text-secondary">Updated: {{ book.dateUpdated | date:'medium' }}</div>
          </div>

          <!-- Summary (read mode) -->
          <div class="mt-4" *ngIf="!editMode">
            <h6 class="text-secondary fw-semibold mb-2">Summary</h6>
            <p class="mb-0" [class.text-muted]="!book.summary">{{ book.summary || 'No summary provided.' }}</p>
          </div>

          <!-- Edit form (edit mode) -->
          <form class="mt-4" *ngIf="editMode" (ngSubmit)="save()" #editForm="ngForm" novalidate>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Title</label>
                <input class="form-control" name="title" [(ngModel)]="draft.title" required minlength="1">
              </div>

              <div class="col-md-6">
                <label class="form-label">Author</label>
                <input class="form-control" name="author" [(ngModel)]="draft.author" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Cover URL</label>
                <div class="input-group">
                  <input class="form-control" name="coverUrl" [(ngModel)]="draft.coverUrl" placeholder="https://...">
                  <button type="button" class="btn btn-outline-secondary"
                          (click)="importCoverFromUrl()" [disabled]="!draft.coverUrl || saving">
                    Import
                  </button>
                </div>
                <div class="form-text">Paste an image link and click Import to store it.</div>
              </div>

              <div class="col-12">
                <label class="form-label">Summary</label>
                <textarea class="form-control" rows="4" name="summary" [(ngModel)]="draft.summary"></textarea>
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary"
                      [disabled]="editForm.invalid || saving">
                {{ saving ? 'Saving…' : 'Save changes' }}
              </button>
              <button type="button" class="btn btn-light" (click)="toggleEdit()" [disabled]="saving">Cancel</button>
            </div>
          </form>

          <!-- Alerts -->
          <div class="mt-3" *ngIf="message">
            <div class="alert" [ngClass]="message.type === 'success' ? 'alert-success' : 'alert-danger'">
              {{ message.text }}
            </div>
          </div>

          <!-- Back link -->
          <div class="mt-2">
            <a class="small text-decoration-none" [routerLink]="['../']">← Back to list</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Optional simple loading state -->
<div class="container py-5 text-center text-muted" *ngIf="!book && loading">
  Loading book…
</div>
