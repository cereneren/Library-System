<!-- book-detail.component.html -->
<div class="container py-3" *ngIf="book">
  <div class="card shadow-sm">
    <div class="row g-0">

      <!-- Cover -->
      <div class="col-md-4 d-flex align-items-stretch">
        <div class="w-100 p-3 d-flex flex-column align-items-center justify-content-center bg-light">
          <div class="ratio" style="--bs-aspect-ratio: 150%; max-width: 320px;">
            <img
              class="book-cover"
              [src]="editMode ? (previewUrl || coverUrl) : coverUrl"
              (error)="onImgError($event)"
              [alt]="(book.title || 'Book') + ' cover'"
              style="width:100%; height:100%; object-fit:cover; border-radius:.5rem;"
              loading="lazy">
          </div>

          <ng-container *ngIf="book as b">
            <!-- Status badge (matches overview) -->
            <span class="badge mt-3" [ngClass]="badgeClass(b)">
              {{ statusKey(b) | translate }}
            </span>

            <!-- Numbers badge (same color logic for consistency) -->
            <span class="badge mt-2" [ngClass]="badgeClass(b)">
              {{ effAvail(b) }} / {{ effTotal(b) }} {{ 'BOOKS.AVAILABLE' | translate }}
            </span>
          </ng-container>

        </div>
      </div>

      <!-- Info + Actions -->
      <div class="col-md-8">
        <div class="card-body">

          <!-- Title row with actions -->
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div>
              <h3 class="mb-1">{{ book.title }}</h3>
              <div class="text-muted">{{ book.author || '—' }}</div>
            </div>
            <div class="d-flex gap-2">
              <button
                *ngIf="!isMember && !editMode"
                class="btn btn-success btn-sm"
                (click)="toggleEdit()"
                [disabled]="saving || deleting"
              >
                <i class="bi bi-pencil"></i>
              </button>
              <button *ngIf="!isMember" class="btn btn-danger btn-sm" (click)="confirmDelete()" [disabled]="saving || deleting">
                <i class="bi bi-trash-fill"></i>
              </button>
            </div>
          </div>

          <!-- Meta -->
          <ng-container *ngIf="locale$ | async as locale">
          <div class="mt-3 small">
            <div class="text-secondary" *ngIf="!isMember">{{ 'BOOKS.CREATED' | translate }}: {{ book.dateCreated | date:'mediumDate':undefined:locale }}</div>
            <div class="text-secondary" *ngIf="!isMember">{{ 'BOOKS.UPDATED' | translate }}: {{ book.dateUpdated | date:'mediumDate':undefined:locale }}</div>
            <!-- Current loan due date -->
            <div *ngIf="currentLoan?.dueDate as due" class="text-secondary mb-2">
              {{ 'LOANS.EXPECTED_DUE' | translate }}: {{ due | date:'mediumDate':undefined:locale }}
              <span *ngIf="isOverdue(due)" class="ms-2">
                ({{ 'LOANS.OVERDUE' | translate }} —
                 {{ daysOverdue(due) }}
                 {{ daysOverdue(due) === 1 ? ('BOOKS.DAY' | translate) : ('BOOKS.DAYS' | translate) }})
              </span>
            </div>
          </div>
          </ng-container>

          <!-- Summary (read mode) -->
          <div class="mt-4" *ngIf="!editMode">
            <h6 class="text-secondary fw-semibold mb-2"> {{ 'BOOKS.SUMMARY' | translate }}</h6>
            <p class="mb-0" [class.text-muted]="!book.summary">{{ book.summary || ('BOOKS.NO_SUMMARY' | translate) }}</p>
          </div>

          <!-- Edit form (edit mode) -->
          <form class="mt-4" *ngIf="editMode" (ngSubmit)="save()" #editForm="ngForm" novalidate>
            <div class="row g-3">
              <!-- Title / Author (proper columns directly under .row) -->
              <div class="col-12 col-md-6">
                <label class="form-label">{{ 'BOOKS.TITLE' | translate }}</label>
                <input class="form-control" name="title" [(ngModel)]="draft.title" required minlength="1">
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">{{ 'BOOKS.AUTHOR' | translate }}</label>
                <input class="form-control" name="author" [(ngModel)]="draft.author" required>
              </div>

              <!-- Cover upload + Total copies side-by-side in the SAME row -->
              <div class="col-12 col-md-8">
                <label class="form-label">{{ 'BOOKS.COVER' | translate }}</label>
                <input
                  type="file"
                  class="form-control"
                  accept="image/jpeg,image/png,image/webp"
                  (change)="onCoverFileSelected($event)"
                  [disabled]="saving"/>
                <div class="form-text">
                  {{ 'BOOKS.CHOOSE_IMAGE' | translate:{ ex:'JPG/PNG/WEBP', size:'5MB' } }}
                </div>
              </div>

              <div class="col-12 col-md-4" *ngIf="book as b">
                <label class="form-label mb-1">{{ 'BOOKS.TOTAL_STOCK' | translate }}</label>
                <input
                  type="number"
                  class="form-control"
                  name="totalCopies"
                  [(ngModel)]="draft.totalCopies"
                  min="0"
                  [disabled]="saving" />
                <small class="text-muted d-block mt-1">
                  {{ 'BOOKS.AVAILABLE' | translate }}: {{ b.availableCopies }}
                </small>
              </div>

              <!-- Summary -->
              <div class="col-12">
                <label class="form-label">{{ 'BOOKS.SUMMARY' | translate }}</label>
                <textarea class="form-control" rows="4" name="summary" [(ngModel)]="draft.summary"></textarea>
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid || saving">
                {{ saving ? ('BOOKS.SAVING' | translate) : ('BOOKS.SAVE_CHANGES' | translate) }}
              </button>
              <button type="button" class="btn btn-light" (click)="toggleEdit()" [disabled]="saving">
                {{ 'BOOKS.CANCEL' | translate }}
              </button>
            </div>
          </form>


          <!-- Alerts -->
          <div class="mt-3" *ngIf="message">
            <div class="alert" [ngClass]="message.type === 'success' ? 'alert-success' : 'alert-danger'">
              {{ message.text }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isMember && !editMode"  id="toggleGroup">
    <div class="row mt-3">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="card-body d-flex gap-2 flex-wrap">
              <button
                class="btn btn-primary collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#loansCollapse"
                aria-expanded="false"
                aria-controls="loansCollapse">
                {{ 'MEMBERS.LOANS' | translate }}
              </button>

              <ng-container *ngIf="book as b">
                <button
                  class="btn btn-secondary"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#borrowCollapse"
                  aria-expanded="false"
                  aria-controls="borrowCollapse"
                  [disabled]="!b.available || borrowing || loadingLoan">
                  {{ 'MEMBERS.BORROW' | translate }}
                </button>
              </ng-container>
            </div>
          </div>

          <!-- Loans collapse -->
          <div class="collapse" id="loansCollapse" data-bs-parent="#toggleGroup">
            <div class="card card-body">
              <div *ngIf="loansLoading" class="text-muted">Loading loans…</div>

              <div *ngIf="!loansLoading && loans.length === 0" class="text-muted">
                {{ 'BOOKS.NO_LOANS' | translate }}
              </div>

              <div *ngIf="!loansLoading && loans.length > 0" class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                  <!-- stats row (same style as your example) -->
                  <div class="d-flex flex-wrap gap-4 mb-2 m-1">
                    <div class="fw-semibold">
                      {{ 'MEMBERS.TOTAL_LOANS' | translate }}:
                      <span class="fw-normal">{{ totalLoans }}</span>
                    </div>
                    <div class="fw-semibold">
                      {{ 'MEMBERS.ACTIVE_LOANS' | translate }}:
                      <span class="fw-normal">{{ activeLoansCount }}</span>
                    </div>
                    <div class="fw-semibold text-danger">
                      {{ 'MEMBERS.OVERDUE' | translate }}:
                      <span class="fw-normal">{{ overdueLoansCount }}</span>
                    </div>
                  </div>

                  <tr>
                    <th>{{ 'MEMBERS.MEMBER' | translate }}</th>
                    <th>{{ 'LOANS.LOANED' | translate }}</th>
                    <th>{{ 'LOANS.DUE' | translate }}</th>
                    <th>{{ 'MEMBERS.STATUS' | translate }}</th>
                    <th class="text-end"></th>
                  </tr>
                  </thead>

                  <tbody>
                  <tr *ngFor="let loan of loans | paginate: { id: 'loansPager', itemsPerPage: 10, currentPage: page }">
                    <ng-container *ngIf="locale$ | async as locale">
                      <td>{{ loan.member.fullName || loan.member.email || '—' }}</td>
                      <td>{{ loan.loanDate | date:'mediumDate':undefined:locale }}</td>
                      <td>{{ loan.dueDate   | date:'mediumDate':undefined:locale }}</td>
                      <td>
                <span *ngIf="loan.returnDate" class="badge bg-success">
                  {{ 'MEMBERS.RETURNED' | translate }}
                  {{ loan.returnDate | date:'mediumDate':undefined:locale }}
                </span>
                        <span *ngIf="!loan.returnDate && isOverdue(loan)" class="badge bg-danger">
                  Overdue
                </span>
                        <span *ngIf="!loan.returnDate && !isOverdue(loan)" class="badge bg-warning text-dark">
                  {{ 'MEMBERS.ON_LOAN' | translate }}
                </span>
                      </td>
                    </ng-container>

                    <td class="text-end">
                      <button
                        *ngIf="!loan.returnDate"
                        class="btn btn-outline-primary btn-sm"
                        (click)="onReturn(loan)"
                        [disabled]="returning[loan.id]">
                        {{ returning[loan.id] ? ('MEMBERS.RETURNING' | translate) : ('MEMBERS.RETURN' | translate) }}
                      </button>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>

              <!-- pagination-template wired to the same id and using onPageChange -->
              <pagination-template
                *ngIf="loans.length > 10"
                #api="paginationApi"
                [id]="'loansPager'"
                (pageChange)="onPageChange($event)">

                <nav class="d-flex justify-content-center mt-3" aria-label="Loans pagination">
                  <ul class="pagination mb-0">
                    <!-- First -->
                    <li class="page-item" [class.disabled]="api.isFirstPage()">
                      <button class="page-link" (click)="api.setCurrent(1)">
                        <i class="bi bi-chevron-double-left" aria-hidden="true"></i>
                        <span class="visually-hidden">First</span>
                      </button>
                    </li>

                    <!-- Prev -->
                    <li class="page-item" [class.disabled]="api.isFirstPage()">
                      <button class="page-link" (click)="api.previous()">
                        <i class="bi bi-chevron-left" aria-hidden="true"></i>
                        <span class="visually-hidden">Previous</span>
                      </button>
                    </li>

                    <!-- Numbers -->
                    <li class="page-item"
                        *ngFor="let pg of api.pages"
                        [class.active]="api.getCurrent() === pg.value">
                      <button class="page-link" (click)="api.setCurrent(pg.value)">
                        {{ pg.label }}
                      </button>
                    </li>

                    <!-- Next -->
                    <li class="page-item" [class.disabled]="api.isLastPage()">
                      <button class="page-link" (click)="api.next()">
                        <i class="bi bi-chevron-right" aria-hidden="true"></i>
                        <span class="visually-hidden">Next</span>
                      </button>
                    </li>

                    <!-- Last -->
                    <li class="page-item" [class.disabled]="api.isLastPage()">
                      <button class="page-link" (click)="api.setCurrent(api.getLastPage())">
                        <i class="bi bi-chevron-double-right" aria-hidden="true"></i>
                        <span class="visually-hidden">Last</span>
                      </button>
                    </li>
                  </ul>
                </nav>
              </pagination-template>

            </div>
          </div>



          <!-- Borrow Collapse -->
          <div class="collapse" id="borrowCollapse" data-bs-parent="#toggleGroup">
            <div class="card card-body border border-light-subtle shadow-sm">
              <div class="mb-3">
                <label class="form-label">{{ 'BOOKS.SELECT_MEMBER' | translate }}</label>

                <!-- Bootstrap dropdown (members) -->
                <div class="dropdown w-100 " style="width: 260px;" data-bs-auto-close="outside">
                  <button
                    class="btn btn-light border d-flex justify-content-between align-items-center"
                    style="width: 240px;"
                    type="button"
                    id="memberDropdown"
                    data-bs-toggle="dropdown"
                    [disabled]="borrowing || members.length === 0"
                    aria-expanded="false">
                    <span class="text-truncate">
                      {{ selectedMemberLabel || ('BOOKS.SELECT_BOX_MESSAGE' | translate) }}
                    </span>
                    <i class="bi bi-chevron-down ms-2"></i>
                  </button>

                  <div class="dropdown-menu w-100 p-2" aria-labelledby="memberDropdown" style="max-height: 320px; overflow: auto;">
                    <!-- search box inside dropdown -->
                    <div class="input-group input-group-sm mb-2">
                      <input
                        class="form-control"
                        type="search"
                        [placeholder]="'Search' | translate"
                        [(ngModel)]="memberQuery"
                        name="memberQuery"
                        (click)="$event.stopPropagation()"
                        (keydown.enter)="$event.preventDefault()"/>
                      <button class="btn btn-outline-secondary" type="button" (click)="memberQuery=''">✕</button>
                    </div>

                    <!-- member list -->
                    <button
                      *ngFor="let m of filteredMembers"
                      type="button"
                      class="dropdown-item"
                      (click)="chooseMember(m)">
                      <span class="d-block text-truncate">{{ m.fullName || m.email }}</span>
                      <small class="text-muted" *ngIf="m.email && m.fullName">{{ m.email }}</small>
                    </button>

                    <div *ngIf="filteredMembers.length === 0" class="dropdown-item text-muted small">
                      {{ 'BOOKS.MATCH_ERROR' | translate }}
                    </div>
                  </div>

                  <!-- Days selector -->
                  <div class="mb-3 mt-3">
                    <label class="form-label"> {{ 'MEMBERS.SELECT_DAYS' | translate }} </label>
                    <select
                      class="form-select"
                      style="max-width: 16rem;"
                      [(ngModel)]="selectedNumberOfDays"
                      name="loanDays"
                      [disabled]="borrowing">
                      <option *ngFor="let d of days" [ngValue]="d">{{ d }}</option>
                    </select>
                  </div>
                </div>

                <div *ngIf="members.length === 0" class="text-muted small mt-1">
                  {{ 'MEMBERS.LIST_LOAD_FAILED' | translate }}
                </div>
              </div>

              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  (click)="onBorrow()"
                  [disabled]="borrowing || !book.id || !selectedMemberId">
                  {{ borrowing ? ('MEMBERS.BORROWING' | translate) : ('MEMBERS.BORROW' | translate) }}
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
</div>
</div>
