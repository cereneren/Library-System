<!-- Filter bar -->
<div class="filter-bar m-4 " *ngIf="!loading && loans.length">
  <div class="form-check form-check-inline form-check-xl mx-3">
    <input id="fReturned"
           class="form-check-input"
           type="checkbox"
           [(ngModel)]="filters.returned"
           (ngModelChange)="page = 1">
    <label class="form-check-label" for="fReturned">{{ 'LOANS.RETURNED' | translate }}</label>
  </div>

  <div class="form-check form-check-inline form-check-xl mx-3">
    <input id="fOnLoan"
           class="form-check-input"
           type="checkbox"
           [(ngModel)]="filters.onLoan"
           (ngModelChange)="page = 1">
    <label class="form-check-label" for="fOnLoan">{{ 'LOANS.ON_LOAN' | translate }}</label>
  </div>

  <div class="form-check form-check-inline form-check-xl mx-3">
    <input id="fOverdue"
           class="form-check-input"
           type="checkbox"
           [(ngModel)]="filters.overdue"
           (ngModelChange)="page = 1">
    <label class="form-check-label" for="fOverdue">{{ 'LOANS.OVERDUE' | translate }}</label>
  </div>

  <!-- All -->
  <div class="form-check form-check-inline mx-3">
    <input class="form-check-input"
           type="checkbox"
           [checked]="allChecked"
           [indeterminate]="isCustom"
           (change)="setAllFilters(true); page = 1">
    <label class="form-check-label">{{ 'LOANS.ALL' | translate }}</label>
  </div>

  <!-- None -->
  <div class="form-check form-check-inline mx-3">
    <input class="form-check-input"
           type="checkbox"
           [checked]="noneChecked"
           [indeterminate]="isCustom"
           (change)="setAllFilters(false); page = 1">
    <label class="form-check-label">{{ 'LOANS.NONE' | translate }}</label>
  </div>
</div>
<!-- No results messages -->
<div *ngIf="!loading && loans.length === 0" class="text-muted">{{ 'LOANS.NO_LOANS_FOUND' | translate }}</div>
<div *ngIf="!loading && loans.length > 0 && filteredLoans.length === 0" class="text-muted">
  {{ 'LOANS.NO_LOANS_MATCHED' | translate }}
</div>

<!-- Table -->
<div *ngIf="!loading && filteredLoans.length" class="table-responsive mt-4 mb-4 m-4 text-xl">
  <table class="table align-middle">
    <thead>
    <tr>
      <th>{{ 'LOANS.TITLE' | translate }}</th>
      <th>{{ 'LOANS.AUTHOR' | translate }}</th>
      <th *ngIf="isLibrarian">{{ 'LOANS.MEMBER' | translate }}</th>
      <th>{{ 'LOANS.LOANED' | translate }}</th>
      <th>{{ 'LOANS.DUE' | translate }}</th>
      <th>{{ 'LOANS.STATUS' | translate }}</th>
      <th class="text-end" *ngIf="isLibrarian"></th>
    </tr>
    </thead>

    <tbody>
    <ng-container *ngIf="locale$ | async as locale">
      <!-- NOTE: paginate pipe added; page id changed to 'loansPager' -->
      <tr *ngFor="let l of filteredLoans | paginate: { id: 'loansPager', itemsPerPage: 10, currentPage: page }">
        <td class="fw-semibold">{{ l.book.title }}</td>
        <td>{{ l.book.author || '-' }}</td>
        <td *ngIf="isLibrarian">{{ l.member?.fullName || 'â€”' }}</td>
        <td>{{ l.loanDate | date:'mediumDate':undefined:locale }}</td>
        <td>{{ l.dueDate   | date:'mediumDate':undefined:locale }}</td>
        <td>
            <span *ngIf="l.returnDate" class="badge bg-success">
              {{ 'LOANS.RETURNED' | translate }} {{ l.returnDate | date:'mediumDate':undefined:locale }}
            </span>
          <span *ngIf="!l.returnDate && isOverdue(l)" class="badge bg-danger">{{ 'LOANS.OVERDUE' | translate }}</span>
          <span *ngIf="!l.returnDate && !isOverdue(l)" class="badge bg-warning text-dark">{{ 'LOANS.ON_LOAN' | translate }}</span>
        </td>
        <td class="text-end" *ngIf="isLibrarian">
          <button class="btn btn-outline-primary btn-sm text-xl"
                  *ngIf="!l.returnDate"
                  (click)="onReturn(l)"
                  [disabled]="returning[l.id]">
            {{ returning[l.id] ? ('LOANS.RETURNING' | translate) : ('LOANS.RETURN' | translate) }}
          </button>
        </td>
      </tr>
    </ng-container>
    </tbody>
  </table>

  <!-- pagination-template wired to the same id and using onPageChange -->
  <pagination-template
    *ngIf="filteredLoans.length > 10"
    #api="paginationApi"
    [id]="'loansPager'"
    (pageChange)="onPageChange($event)">

    <nav class="d-flex justify-content-center mt-3" aria-label="Loans pagination">
      <ul class="pagination mb-0">
        <!-- First -->
        <li class="page-item" [class.disabled]="api.isFirstPage()">
          <button class="page-link" (click)="api.setCurrent(1)">
            <i class="bi bi-chevron-double-left" aria-hidden="true"></i>
            <span class="visually-hidden">First</span>
          </button>
        </li>

        <!-- Prev -->
        <li class="page-item" [class.disabled]="api.isFirstPage()">
          <button class="page-link" (click)="api.previous()">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
            <span class="visually-hidden">Previous</span>
          </button>
        </li>

        <!-- Numbers -->
        <li class="page-item"
            *ngFor="let pg of api.pages"
            [class.active]="api.getCurrent() === pg.value">
          <button class="page-link" (click)="api.setCurrent(pg.value)">
            {{ pg.label }}
          </button>
        </li>

        <!-- Next -->
        <li class="page-item" [class.disabled]="api.isLastPage()">
          <button class="page-link" (click)="api.next()">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
            <span class="visually-hidden">Next</span>
          </button>
        </li>

        <!-- Last -->
        <li class="page-item" [class.disabled]="api.isLastPage()">
          <button class="page-link" (click)="api.setCurrent(api.getLastPage())">
            <i class="bi bi-chevron-double-right" aria-hidden="true"></i>
            <span class="visually-hidden">Last</span>
          </button>
        </li>
      </ul>
    </nav>
  </pagination-template>

</div>
